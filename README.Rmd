---
output:
    github_document:
    pandoc_args: --webtex
always_allow_html: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "imgs/",
  out.width = "100%"
)

knitr::opts_chunk$set(echo = TRUE)
```


<!-- badges: start -->
![forthebadge](https://img.shields.io/badge/GEMM-Building-orange)
![forthebadge](https://forthebadge.com/images/badges/built-with-science.svg)

<!-- badges: end -->

# AnÃ¡lise do Metagenoma total - Shotgun <img src="imgs/1.png" align="right" width = "120px"/>
**Autor: MsC. Kelly Hidalgo**

ğŸ‡§ğŸ‡· Pipeline para a montagem e anotaÃ§Ã£o funcional de metagenomas totais. Este pipeline contempla todas as etapas do processamento, desde a avaliaÃ§Ã£o da qualidade das sequÃªncias, trimagem, montagem, cÃ¡lculo da cobertura, prediÃ§Ã£o e anotaÃ§Ã£o funcional e taxonÃ´mica dos genes. 

> ğŸ‡ªğŸ‡¸Pipeline para montaje y anotaciÃ³n funcional de metagenomas totales. Este pipeline contempla todas las etapas del procesamiento, desde la evaluaciÃ³n de la calidad de las secuencias, *trimming*, montaje, cÃ¡lculo de la cobertura, predicciÃ³n y anotaciÃ³n funcional y taxonÃ³mica de genes. 

## Ferramientas bioinformÃ¡ticas

### InstalaÃ§Ã£o

**1. InstalÃ§Ã£o Miniconda**

ğŸ‡§ğŸ‡· Ã‰ recomendÃ¡vel instalar Anaconda, pois Ã© a forma mais fÃ¡cil para instalar as ferramentas bioinformÃ¡ticas necessÃ¡rias pro desenvolvimento deste pipeline. Anaconda Ã© uma distribuiÃ§Ã£o livre e aberta das linguagens *Python* e *R*, utilizada na ciÃªncia de dados e bioinformÃ¡tica. As diferente versÃµes dos programas se administram mediante um sinstema de gestÃ£o chamado *conda*, o qual faz bastante simples instalar, rodar e atualizar programas. [Aqui](https://conda.io/projects/conda/en/latest/user-guide/install/index.html) se encontram as instruÃ§Ãµes para a instalaÃ§Ã£o de Anaconda. 

Depois de instalado, *Anaconda* e o gestor *Conda*, podram ser criados *ambientes virtuais* par a instalaÃ§Ã£o das diferentes ferramentas bioinformÃ¡tica que serÃ£o usadas. 

> ğŸ‡ªğŸ‡¸ Es recomendable instalar Anaconda, pues es la forma mÃ¡s fÃ¡cil para instalar las herramientas bioinformÃ¡ticas necesarias para el desarrollo de este pipeline. Anaconda es una distribuciÃ³n libre y abierta de los lenguajes *Python* y *R*, utilizada en ciencia de datos y bioinformÃ¡tica. Las diferentes versiones de los programas se administran mediante un sistema de gestiÃ³n llamado *conda*, el cual hace bastante sencillo instalar, correr y actualizar programas.  [Aqui](https://conda.io/projects/conda/en/latest/user-guide/install/index.html) se encuentran las instrucciones para la instalaciÃ³n de Anaconda.
>
> DespuÃ©s de instalado *Anaconda* y su gestor *Conda*, podran ser creados *ambientes virtuales* para la instalaciÃ³n de las diferentes herramientas bioinformÃ¡ticas que serÃ¡n usadas.

**2. InstalaÃ§Ã£o FastQC**

ğŸ‡§ğŸ‡· [FastQC](http://www.bioinformatics.babraham.ac.uk/projects/fastqc/) Ã© uma ferramenta para avaliar graficamente a qualidade das sequencias de Illumina.

Las instruÃ§Ãµes para a instalaÃ§Ã£o usando conda se encontram [aqui](https://anaconda.org/bioconda/fastqc). No entanto neste tutorial tambÃ©m serÃ£o apresentados.

Como jÃ¡ foi explicado anteriormente, com conda Ã© possÃ­vel criar ambientes virtuais para instalar as ferramentas bioinformÃ¡ticas. O primeiro ambiente que serÃ¡ criado se chamarÃ¡ **QualityControl**, onde se instalaram os programas relacionados com esse processo.

> ğŸ‡ªğŸ‡¸ [FastQC](http://www.bioinformatics.babraham.ac.uk/projects/fastqc/) es una herramienta para evaluar graficamente la calidad de las secuencias de Illumina. 
>
> Las instrucciones para instalaciÃ³n usando conda se encuentran [aqui](https://anaconda.org/bioconda/fastqc). Sin embargo aqui en este tutorial tambiÃ©n serÃ¡n presentadas
>
> Como ya fue explicado anteriorimente, con conda es posible crear ambientes virutuales para instalar las herramientas bioinformÃ¡ticas. El primer ambiente que serÃ¡ creado se llamarÃ¡ **QualityControl**, donde se instalaran los programas relacionados con este proceso.

```
conda create -n QualityControl
```
ğŸ‡§ğŸ‡· Durante o processo, o sistema perguntarÃ¡ se deseja proceder com a creaÃ§Ã£o do ambiente, com as opÃ§Ãµes y/n (sim ou nÃ£o). Escreva `y` e depois disso o ambiente virutal estarÃ¡ criado.

Para instalar as ferramentas dentro do ambiente anteriormente criado, Ã© necessÃ¡rio ativÃ¡-lo.

> ğŸ‡ªğŸ‡¸ Durante el proceso, el sistema preguntarÃ¡ sÃ­ desea proceder con la creaciÃ³n del ambiente, con las opciones y/n (si o no). Escriba `y` y despuÃ©s de eso el ambiente virtual estarÃ¡ creado.
>
> Para instalar las herramientas dentro del ambiente anteriormente creado, es necesario activarlo

```
conda activate QualityControl
```
ğŸ‡§ğŸ‡· O ambiente estarÃ¡ ativo quando o nome se encontre ao comeÃ§o da linha do comando, asssim: `(QualityControl) user@server:~/$`.
Posteriormente se procede Ã  instalaÃ§Ã£o do programa:

> ğŸ‡ªğŸ‡¸ El ambiente estarÃ¡ activo cuando el nombre de Ã©ste se encuentra en el comienzo de la linea de comando, asÃ­: `(QualityControl) user@server:~/$`.
> 
> Posteriormente se procede a la instalaciÃ³n del programa:

```
conda install -c bioconda fastqc
```

**3. InstalaÃ§Ã£o Trimmomatic v0.39**

ğŸ‡§ğŸ‡· [Trimmomatic](http://www.usadellab.org/cms/?page=trimmomatic) Ã© um programa pra filtrar (remover) leituras ou *reads* curtas de baixa qualidade.

Como se trata de uma ferramenta que participa dentro do processo de control de qualidade, serÃ¡ instalada dentro do ambiente virtual **QualityControl**.

> ğŸ‡ªğŸ‡¸ [Trimmomatic](http://www.usadellab.org/cms/?page=trimmomatic) es un programa para filtrar (remover) lecturas o *reads* cortas de baja calidad.
> 
> Como se trata de una herramienta que participa dentro del proceso de control de calidad, serÃ¡ instalada dentro del ambiente virtual **QualityControl**

```
# Si no estÃ¡ activado el ambiente
conda activate QualityControl

# Instale Trimmomatic
conda install -c bioconda trimmomatic
```

---
## 0. Organizando os dados

### 0.1. SequÃªncias

ğŸ‡§ğŸ‡· En este tutorial serÃ£o usados 4 meteganomas, pode decarregÃ¡-los [aqui](colgarlosdatos.com).

Antes de descarregar os *datasets*, crie os seguintes directÃ³rios para a organizaÃ§Ã£o dos dados.

> ğŸ‡ªğŸ‡¸ En este tutorial serÃ¡n usados 4 metagenomas, puede descargarlos [aqui](colgarlosdatos.com).
>
> Antes de descargar los *datasets*, cree los siguientes directorios para la organizaciÃ³n de los datos.

```
# Crie uma pasta raÃ­z chamada metagenomica
mkdir metagenomica
cd metagenomica/

# Crie um diretÃ³rio para colocar os dados
mkdir 00.RawData
cd 00.RawData/
```

ğŸ‡§ğŸ‡· Use o comando `wget` para descarregar os dados desde este [link](colgarlosdatos.com).

> ğŸ‡ªğŸ‡¸ Use el comando `wget` para descargarlos los datos desde este [link](colgarlosdatos.com).

## 1. Controle de Qualidade

### 1.1. FastQC

ğŸ‡§ğŸ‡· A primeira etapa do processo Ã© a avaliaÃ§Ã£o da qualidade das sequÃªncias cortas (Illumina paired end) usando *FastQC*, com o objetivo de determianr se Ã© necessÃ¡rio trimar ou filtrar as sequÃªncias da baixa qualidade para nos prÃ³ximos pasos. 

Esta etapa Ã© para identificar principalmente as sequÃªncias *outlier* com baixa qualidade ($Q<20$)

Ative o ambiente `QualityControl`:

> ğŸ‡ªğŸ‡¸ La primera etapa del proceso es la evaluaciÃ³n de la calidad de las secuencias cortas (Illumina paired end) usando *FastQC*, con el objetivo de determinar sÃ­ es necesario trimar o filtrar las secuencias de baja calidad en los prÃ³ximos pasos. 
>
> Ã‰sta etapa es para identificar principalmente las secuencias *outlier* con baja calidad ($Q<20$).
>
> Active el ambiente `QualityControl`:

```
conda activate QualityControl

## Onde vc estÃ¡?
pwd
```

ğŸ‡§ğŸ‡· Deve etsar em `~/metagenomica/`.. Se esse nÃ£o Ã© o resultado del comando `pwd`, use o comando `cd` para chegar no diretÃ³rio desejado.

> ğŸ‡ªğŸ‡¸ Debe estar em `~/metagenomica/`. Si ese no es el resultado del comando `pwd`, use el comando `cd` para llegar en el directorio base.

Execute  **FastQC**:
```
## Crie um directÃ³rio para salvar o output do FastQC
mkdir 01.FastqcReports
## Run usando 10 threads
fastqc -t 10 00.RawData/* -o 01.FastqcReports/
```

**Sintaxis**
fastqc [opÃ§Ãµes] input -o output

ğŸ‡§ğŸ‡· O comando `fastqc` tem vÃ¡rias opÃ§Ãµes ou parÃ¢metros, entre eles, escolher o nÃºmero de nÃºcleos da mÃ¡quina para rodar a anÃ¡lise, para este exemplo `-t 10`. O input Ã© o diretÃ³rio que contem as sequÃªncias `00.RawData/*`, o `*` indica ao sistema que pode analisar todos os arquivos que estÃ£o dentro desse diretÃ³rio. O output, indicado pelo parÃ¢mtero `-o`, Ã© o diretÃ³rio onde se deseja que sejam guardados os resultados da anÃ¡lise. A continuaÃ§Ã£o se encontram uma explicaÃ§Ã£o detalhada de cada output gerado.

> ğŸ‡ªğŸ‡¸ El comando `fastqc` tiene varias opciones o parametros, entre ellas, escoger el nÃºmero de nÃºcleos de la mÃ¡quina para correr el anÃ¡lisis, para este caso `-t 10`. El input es el directorio que contiene las secuencias `00.RawData/*`, el `*` indica al sistema que puede analizar todos los archivos que estÃ¡n dentro de ese directorio. El output, indicado por el parametro `-o`, es el directorio donde se desea que sean guardados los resultados del anÃ¡lisis. A continuaciÃ³n se encuentra una explicaciÃ³n detallada de cada output generado.

**Outputs**

ğŸ‡§ğŸ‡· * Reportes html `.html`: Aqui Ã© possÃ­vel ver toda informaÃ§Ã£o de qualidade graficamente. 
* Zip files `.zip`: Aqui se encontram cada um dos grÃ¡ficos de maneira separada. **IGNORE**

Descaregue os arquivos `html` e explore no seu *web browser*. 

Observe as estatÃ­sticas bÃ¡sicas que se encontram na primeira tabela. AlÃ­, vocÃª pode saber quantas sequÃªncias tem, o tamanho e o %GC. O grÃ¡fico mais importante para saber a quealidade das leituras, Ã© o primeiro, *Per base sequence quality*. Este grÃ¡fico Ã© um boxplot com a distribuiÃ§Ã£o dos valores de qualidade *Phred Score* (eje y) em cada um dos nucleotÃ­deos das leituras (eje x). Se consideram sequÃªncias de excelente qualidade quando o $Phred Score > 30$. Ã‰ norla que o pair 2 apresente uma qualidade um pouco inferior ao pair 1.

> ğŸ‡ªğŸ‡¸ Observe las estadÃ­sticas bÃ¡sicas que se encuentran en la primera tabla. AllÃ­, ud puede saber cuantas secuencias tiene, el tamaÃ±o y el %GC. El grÃ¡fico mÃ¡s importante para saber la calidad de las lecturas es el primero, *Per base sequence quality*. Este grÃ¡fico es un boxblot con la distribuciÃ³n de los valores de calidad *Phred Score* (eje y) en cada uno de los nucleÃ³tidos de las lecturas (eje x). Se consideran secuencias de excelente calidad cuando el $Phred Score > 30$. Es normal que el pair 2 presente una calidad un poco inferior al pair 1. 


### 1.2. Trimmomatic

ğŸ‡§ğŸ‡· Segundo foi avaliado no controle de qualidade, pode ser necessÃ¡rio filtrar algumas leituras com qualidade baixa.

O programa Trimmomatic tem vÃ¡rios parÃ¢metros que podem ser considerados para filtrar reads com baixa qualidade. Aqui usaremos alguns. Se quer saber que outros parÃ¢metros e como funciona cada um deles, consulte o [manual](http://www.usadellab.org/cms/uploads/supplementary/Trimmomatic/TrimmomaticManual_V0.32.pdf).

Para os dados aqui analizados se usara a seguinte linha de comando:

> ğŸ‡ªğŸ‡¸ SegÃºn fue evaluado en el control de calidad, puede ser necesario filtrar algunas lecturas con calidad baja.
>
> El programa Trimmomatic tiene vÃ¡rios parametros que pueden ser considerados para filtrar lecturas con baja calidad. Aqui usaremos algunos. Si quiere saber que otros parametros y como funciona cada uno de ellos, consulte el [manual](http://www.usadellab.org/cms/uploads/supplementary/Trimmomatic/TrimmomaticManual_V0.32.pdf).
> 
> Para los datos aqui analizados se usarÃ¡ la siguiente linea de comando:

```
# Activa o ambiente QualityControl
conda activate QualityControl

# Crie uma pasta para salvar as reads limpas
mkdir 02.CleandData

# Crie uma pasta para salvar as reads nÃ£o pareadas
mkdir unpaired

# Corra Trimmomatic
trimmomatic PE -threads 10 00.RawData/sample1_1.fastq.gz 00.RawData/sample1_2.fastq.gz 02.CleandData/sample1_1_paired.fastq.gz unpaired/sample1_1_unpaired.fastq.gz 02.CleandData/sample1_2_paired.fastq.gz unpaired/sample1_2_unpaired.fastq.gz LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:150
```

ğŸ‡§ğŸ‡· Com o comando anterior vocÃª tem que rodar a linha de comando para cada amostra. Se quiser rodar todas as amostras de maneira automÃ¢tica Ã© possÃ­vel usar um *loop* `for` para executar esta tarefa.

> ğŸ‡ªğŸ‡¸ Con el comnado anterior ud tiene que correr esa lÃ­nea de comando para cada muestra. Si quiere correr todas las muestras de manera automÃ¡tica es posible usar un *loop* `for` para ejecutrar esta tarea. 

```
# loop
for i in 00.RawData/*1.fq.gz 
do
BASE=$(basename $i 1.fq.gz)
trimmomatic PE -threads 20 $i  00.RawData/${BASE}2.fq.gz 02.CleanData/${BASE}1_paired.fq.gz unpaired/${BASE}1_unpaired.fq.gz 02.CleanData/${BASE}2_paired.fq.gz unpaired/${BASE}2_unpaired.fq.gz LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:150
done
```

**Sintaxis**
trimmomatic PE -threads input_forward input_reverse output_forward_paired output_forward_unpaired output_reverse_paired output_reverse_unpaired [opÃ§Ãµes]

ğŸ‡§ğŸ‡· O comando anterior tem muitas partes. Primeiro, o nome do comando Ã© `trimmomatic`, a continuaÃ§Ã£o a opÃ§Ã£o `PE` indica para o programa que as sequÃªncias que irÃ£o ser analisadas sÃ£o de tipo *paired end*. Depois se encontram os inputs, forward (pair1) e reverse (pair2). Depois estÃ£o os outputs, sendo o primeiro, as sequÃªncias forward pareadas (limpas) e nÃ£o pareadas ("descartadas") e depois igual para as sequÃªncias reverse. Por Ãºltimo se encontram os parÃ¢metros de filtragem. Para este caso usamos os parÃ¢metros `SLIDINGWINDOW`, `LEADING` e `TRAILING`. O primeiro de eles, gera uma janela deslizante, que em este caso vai de 4 em 4 bases, cÃ¡lcula a mÃ©dia do *Phred Score* e se estiver por baixo de 15 essas bases serÃ£o cortadas. `LEADING` corta bases do comeÃ§o da leitura que estejam por debaixo do *threshold* de qualidade, igualmente faz o `TRAILING` mas no final das leituras. `MINLEN` elimina todas as reads com tamanho menor ao informado. 

Depois de rodar Trimmomatic Ã© necessÃ¡rio avaliar a qualidade das sequÃªncias limpas usando novamente FastQC.

> ğŸ‡ªğŸ‡¸ El comando anterior tiene muchas partes. Primero, el nombre del comando es `trimmomatic`, a continuaciÃ³n la opciÃ³n `PE` indica para el programa que las secuencias que irÃ¡n a ser analizadas son de tipo *paired end*. DespuÃ©s se encuentran los inputs, forward (pair1) y reverse (pair2). DespuÃ©s son los outputs, siendo primero las secuencias forward pareadas (limpias) y no pareadas ("descartadas") y despuÃ©s las secuencias reverse. Por Ãºltimo se encuentran los parametros de filtrado. Para este caso usamos los parametros `SLIDINGWINDOW`, `LEADING` y `TRAILING`. El primero de ellos, genera una ventana deslizante, que en este caso va de 4 en 4 bases, cÃ¡lcula el promedio del *Phred Score* y si estÃ¡ por debajo de 15 esas bases son cortadas. `LEADING` corta bases del comienzo de la lectura si estÃ¡n por debajo de *threshold* de calidad, lo mismo hace `TRAILING` pero al final de las lecturas. `MINLEN` elimina todas las lecturas con tamaÃ±o menor al informado. 
>
> DespuÃ©s de correr Trimmomatic es necesario evaluar la calidad de las secuencias generadas ("limpias") usando nuevamente FastQC.

```
fastqc -t 10 02.CleandData/* -o 01.FastqcReports/
```

Descargue los reportes `.html` de las secuencias pareadas (i.e. `01.FastqcReports/sample1_1_paired_fastqc.html` y `01.FastqcReports/sample1_2_paired_fastqc.html`).

**ContinuarÃ¡...**




